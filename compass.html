
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Moral Compass — Navigate with Arrow Keys</title>
    <meta name="description" content="Explore the ontological space between Human, Agent, Energy, and Value.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%2306080d'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='monospace' font-size='18' font-weight='bold' fill='%2300f0ff'%3EQi%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --qi-cyan: #00f0ff;
            --qi-cyan-dim: rgba(0, 240, 255, 0.15);
            --qi-cyan-glow: rgba(0, 240, 255, 0.4);
            --qi-amber: #ffb800;
            --qi-amber-dim: rgba(255, 184, 0, 0.15);
            --qi-red: #ff3366;
            --qi-green: #39FF14;
            --qi-purple: #bf5af2;
            --bg-deep: #06080d;
            --bg-panel: #0c1018;
            --bg-card: #111822;
            --border-dim: rgba(0, 240, 255, 0.12);
            --border-bright: rgba(0, 240, 255, 0.3);
            --text-primary: #e8ecf0;
            --text-secondary: #7a8a9e;
            --text-dim: #4a5568;
            --font-display: 'Orbitron', monospace;
            --font-body: 'Rajdhani', sans-serif;
            --font-mono: 'Share Tech Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            overflow: hidden;
            font-family: var(--font-body); 
            background: var(--bg-deep); 
            color: var(--text-primary); 
            font-size: 17px; 
            line-height: 1.6;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 240, 255, 0.008) 2px, rgba(0, 240, 255, 0.008) 4px);
            pointer-events: none;
            z-index: 9999;
        }

        .grid-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(var(--border-dim) 1px, transparent 1px), linear-gradient(90deg, var(--border-dim) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3;
            z-index: 0;
            pointer-events: none;
        }

        /* ==================== BRIEFING SCREEN ==================== */
        .briefing-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-deep);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.5s, visibility 0.5s;
            overflow-y: auto;
        }
        .briefing-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .briefing-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .briefing-title {
            font-family: var(--font-display);
            font-size: clamp(20px, 4vw, 32px);
            font-weight: 700;
            letter-spacing: 6px;
            color: var(--qi-cyan);
            text-shadow: 0 0 40px var(--qi-cyan-glow);
            margin-bottom: 8px;
        }
        .briefing-subtitle {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-secondary);
            letter-spacing: 3px;
        }

        /* Compass Visual */
        .compass-hero {
            position: relative;
            width: 100%;
            max-width: 420px;
            margin-bottom: 20px;
        }
        .compass-svg {
            width: 100%;
            height: auto;
        }

        /* Direction highlights */
        .compass-svg .dir-highlight {
            opacity: 0;
            transition: opacity 0.15s;
        }
        .compass-svg .dir-highlight.active {
            opacity: 1;
        }
        .compass-svg .arrow-north,
        .compass-svg .arrow-east,
        .compass-svg .arrow-south,
        .compass-svg .arrow-west {
            transition: transform 0.15s, filter 0.15s;
        }
        .compass-svg .arrow-north.pulse { transform: translateY(-8px); filter: drop-shadow(0 0 15px #00f0ff); }
        .compass-svg .arrow-east.pulse { transform: translateX(8px); filter: drop-shadow(0 0 15px #ffb800); }
        .compass-svg .arrow-south.pulse { transform: translateY(8px); filter: drop-shadow(0 0 15px #39FF14); }
        .compass-svg .arrow-west.pulse { transform: translateX(-8px); filter: drop-shadow(0 0 15px #bf5af2); }

        /* Tutorial prompt */
        .tutorial-prompt {
            text-align: center;
            margin-bottom: 24px;
        }
        .tutorial-text {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-secondary);
            letter-spacing: 1px;
            margin-bottom: 16px;
        }
        .tutorial-keys {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .key-hint {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--text-dim);
            transition: all 0.15s;
        }
        .key-hint.active {
            border-color: var(--qi-cyan);
            color: var(--qi-cyan);
            box-shadow: 0 0 15px var(--qi-cyan-glow);
            background: var(--qi-cyan-dim);
        }
        .key-hint.north.active { border-color: var(--qi-cyan); color: var(--qi-cyan); box-shadow: 0 0 15px var(--qi-cyan-glow); }
        .key-hint.east.active { border-color: var(--qi-amber); color: var(--qi-amber); box-shadow: 0 0 15px rgba(255,184,0,0.4); }
        .key-hint.south.active { border-color: var(--qi-green); color: var(--qi-green); box-shadow: 0 0 15px rgba(57,255,20,0.4); }
        .key-hint.west.active { border-color: var(--qi-purple); color: var(--qi-purple); box-shadow: 0 0 15px rgba(191,90,242,0.4); }

        .tutorial-progress {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }
        .tutorial-progress span {
            color: var(--qi-cyan);
        }

        /* Briefing info */
        .briefing-info {
            background: var(--bg-panel);
            border: 1px solid var(--border-dim);
            padding: 16px 20px;
            max-width: 500px;
            margin-bottom: 24px;
        }
        .briefing-info h3 {
            font-family: var(--font-display);
            font-size: 9px;
            letter-spacing: 3px;
            color: var(--qi-amber);
            margin-bottom: 12px;
        }
        .briefing-info ul {
            list-style: none;
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-secondary);
        }
        .briefing-info li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .briefing-info li::before {
            content: '◇';
            color: var(--qi-cyan);
            font-size: 8px;
        }

        .briefing-enter {
            font-family: var(--font-display);
            font-size: 11px;
            letter-spacing: 4px;
            padding: 16px 48px;
            background: transparent;
            border: 2px solid var(--qi-cyan);
            color: var(--qi-cyan);
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.3;
            pointer-events: none;
        }
        .briefing-enter.ready {
            opacity: 1;
            pointer-events: auto;
        }
        .briefing-enter.ready:hover {
            background: var(--qi-cyan);
            color: var(--bg-deep);
            box-shadow: 0 0 40px var(--qi-cyan-glow);
        }
        .briefing-enter-hint {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-dim);
            margin-top: 12px;
            letter-spacing: 1px;
        }

        /* ==================== MAIN EXPLORATION ==================== */
        .compass-world {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .compass-world.active { opacity: 1; }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-dim);
            background: rgba(6, 8, 13, 0.9);
            flex-shrink: 0;
        }

        .location-display {
            font-family: var(--font-display);
            font-size: 11px;
            letter-spacing: 3px;
            color: var(--qi-cyan);
            text-shadow: 0 0 20px var(--qi-cyan-glow);
        }

        .energy-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .energy-label {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }
        .energy-bar {
            width: 80px;
            height: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            overflow: hidden;
        }
        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--qi-green), var(--qi-cyan));
            transition: width 0.5s ease;
            box-shadow: 0 0 10px var(--qi-green);
        }
        .energy-value {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--qi-green);
            min-width: 50px;
        }

        .main-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .exploration-zone {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            padding: 16px;
        }

        .node-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }

        .node-content {
            background: var(--bg-panel);
            border: 1px solid var(--border-dim);
            padding: 32px;
            position: relative;
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.25s, transform 0.25s;
        }
        .node-content.transitioning {
            opacity: 0;
            transform: scale(0.95);
        }
        .node-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--node-color, var(--qi-cyan)), transparent);
        }

        .node-title {
            font-family: var(--font-display);
            font-size: clamp(18px, 3vw, 26px);
            font-weight: 700;
            letter-spacing: 4px;
            margin-bottom: 6px;
            color: var(--node-color, var(--qi-cyan));
            text-shadow: 0 0 30px var(--node-glow, var(--qi-cyan-glow));
        }

        .node-subtitle {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-secondary);
            letter-spacing: 2px;
            margin-bottom: 18px;
            text-transform: uppercase;
        }

        .node-description {
            font-size: 15px;
            color: var(--text-primary);
            line-height: 1.8;
            margin-bottom: 18px;
        }

        .node-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
            margin-bottom: 18px;
        }

        .data-block {
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            padding: 10px;
        }
        .data-label {
            font-family: var(--font-mono);
            font-size: 8px;
            color: var(--text-dim);
            letter-spacing: 2px;
            margin-bottom: 3px;
        }
        .data-value {
            font-family: var(--font-display);
            font-size: 13px;
            color: var(--node-color, var(--qi-cyan));
        }

        .node-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .node-tag {
            font-family: var(--font-mono);
            font-size: 8px;
            letter-spacing: 1px;
            padding: 4px 8px;
            background: var(--qi-cyan-dim);
            border: 1px solid var(--border-dim);
            color: var(--qi-cyan);
        }

        /* Locked */
        .locked-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(6, 8, 13, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 28px;
        }
        .locked-icon { font-size: 36px; margin-bottom: 14px; opacity: 0.5; }
        .locked-title {
            font-family: var(--font-display);
            font-size: 13px;
            letter-spacing: 4px;
            color: var(--qi-amber);
            margin-bottom: 8px;
        }
        .locked-desc {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 18px;
            text-align: center;
            max-width: 260px;
            line-height: 1.7;
        }
        .unlock-btn {
            font-family: var(--font-display);
            font-size: 9px;
            letter-spacing: 2px;
            padding: 10px 22px;
            background: transparent;
            border: 1px solid var(--qi-amber);
            color: var(--qi-amber);
            cursor: pointer;
            transition: all 0.3s;
        }
        .unlock-btn:hover:not(:disabled) {
            background: var(--qi-amber);
            color: var(--bg-deep);
        }
        .unlock-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .unlock-cost {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-dim);
            margin-top: 10px;
        }

        /* ==================== MINI COMPASS (corner) ==================== */
        .mini-compass {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 140px;
            height: 140px;
            background: rgba(6, 8, 13, 0.9);
            border: 1px solid var(--border-dim);
            padding: 8px;
            z-index: 50;
        }
        .mini-compass-svg {
            width: 100%;
            height: 100%;
        }
        .mini-compass .arrow-group {
            transition: opacity 0.2s, transform 0.2s;
        }
        .mini-compass .arrow-group.available { opacity: 1; }
        .mini-compass .arrow-group.unavailable { opacity: 0.15; }
        .mini-compass .arrow-group.current { }
        .mini-compass .center-dot {
            transition: fill 0.3s;
        }

        /* ==================== PATHWAY INDEX ==================== */
        .pathway-index {
            width: 220px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border-dim);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .index-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-dim);
        }
        .index-title {
            font-family: var(--font-display);
            font-size: 9px;
            letter-spacing: 3px;
            color: var(--qi-cyan);
            margin-bottom: 3px;
        }
        .index-stats {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-dim);
        }

        .index-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .index-category { margin-bottom: 12px; }
        .index-category-title {
            font-family: var(--font-mono);
            font-size: 8px;
            letter-spacing: 2px;
            color: var(--text-dim);
            padding: 5px;
            border-bottom: 1px solid var(--border-dim);
            margin-bottom: 5px;
        }

        .index-node {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 5px 7px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid transparent;
        }
        .index-node:hover { background: var(--bg-card); border-color: var(--border-dim); }
        .index-node.current { background: var(--qi-cyan-dim); border-color: var(--qi-cyan); }
        .index-node.unexplored { opacity: 0.3; cursor: default; }

        .index-node-icon {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .index-node-icon.explored { background: var(--qi-green); }
        .index-node-icon.current { background: var(--qi-cyan); }
        .index-node-icon.unexplored { background: var(--text-dim); }

        .index-node-name {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }
        .index-node.current .index-node-name { color: var(--qi-cyan); }

        /* ==================== BOTTOM NAV ==================== */
        .hud-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-top: 1px solid var(--border-dim);
            background: rgba(6, 8, 13, 0.95);
            flex-shrink: 0;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn {
            font-family: var(--font-display);
            font-size: 10px;
            width: 30px;
            height: 30px;
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            color: var(--qi-cyan);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-btn:hover:not(:disabled) {
            background: var(--qi-cyan-dim);
            border-color: var(--qi-cyan);
        }
        .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        .nav-btn.back-btn {
            width: auto;
            padding: 0 12px;
            font-size: 9px;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .nav-dpad {
            display: grid;
            grid-template-columns: repeat(3, 30px);
            grid-template-rows: repeat(2, 30px);
            gap: 2px;
        }
        .nav-dpad .nav-btn:nth-child(1) { grid-column: 2; grid-row: 1; }
        .nav-dpad .nav-btn:nth-child(2) { grid-column: 1; grid-row: 2; }
        .nav-dpad .nav-btn:nth-child(3) { grid-column: 2; grid-row: 2; }
        .nav-dpad .nav-btn:nth-child(4) { grid-column: 3; grid-row: 2; }

        .path-display {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-dim);
            letter-spacing: 1px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .path-display span { color: var(--qi-cyan); }

        .back-link {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-dim);
            text-decoration: none;
            letter-spacing: 2px;
            transition: color 0.3s;
        }
        .back-link:hover { color: var(--qi-cyan); }

        .flash-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--qi-cyan);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.1s;
        }
        .flash-overlay.active { opacity: 0.1; }

        @media (max-width: 900px) { .pathway-index { display: none; } }
        @media (max-width: 600px) {
            .path-display { display: none; }
            .mini-compass { width: 100px; height: 100px; bottom: 10px; left: 10px; }
        }
    </style>
</head>
<body>

    <div class="grid-bg"></div>
    <div class="flash-overlay" id="flash"></div>

    <!-- ==================== BRIEFING WITH COMPASS HERO ==================== -->
    <div class="briefing-overlay" id="briefingOverlay">
        
        <div class="briefing-header">
            <h1 class="briefing-title">AI MORAL COMPASS</h1>
            <p class="briefing-subtitle">Navigational Protocol v0.1</p>
        </div>

        <!-- Large Compass Visual -->
        <div class="compass-hero">
            <svg class="compass-svg" id="heroCompass" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="cyanGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#00f0ff" />
                        <stop offset="100%" style="stop-color:#0088aa" />
                    </linearGradient>
                    <linearGradient id="amberGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffb800" />
                        <stop offset="100%" style="stop-color:#cc8800" />
                    </linearGradient>
                    <linearGradient id="greenGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#39FF14" />
                        <stop offset="100%" style="stop-color:#22aa0a" />
                    </linearGradient>
                    <linearGradient id="purpleGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#bf5af2" />
                        <stop offset="100%" style="stop-color:#8a3fbd" />
                    </linearGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                    <filter id="softGlow">
                        <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
                        <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                    <filter id="strongGlow">
                        <feGaussianBlur stdDeviation="8" result="coloredBlur"/>
                        <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                    <radialGradient id="centerGlow" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#00f0ff;stop-opacity:0.15" />
                        <stop offset="100%" style="stop-color:#00f0ff;stop-opacity:0" />
                    </radialGradient>
                </defs>

                <!-- Outer ring -->
                <circle cx="250" cy="250" r="230" fill="none" stroke="rgba(0, 240, 255, 0.15)" stroke-width="1"/>
                
                <!-- Tick marks -->
                <g stroke="rgba(0, 240, 255, 0.3)" stroke-width="1">
                    <line x1="250" y1="25" x2="250" y2="35" transform="rotate(0, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="32" transform="rotate(30, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="32" transform="rotate(60, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="35" transform="rotate(90, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="32" transform="rotate(120, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="32" transform="rotate(150, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="35" transform="rotate(180, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="32" transform="rotate(210, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="32" transform="rotate(240, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="35" transform="rotate(270, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="32" transform="rotate(300, 250, 250)"/>
                    <line x1="250" y1="25" x2="250" y2="32" transform="rotate(330, 250, 250)"/>
                </g>

                <!-- Dashed inner ring -->
                <circle cx="250" cy="250" r="195" fill="none" stroke="rgba(0, 240, 255, 0.08)" stroke-width="1" stroke-dasharray="4 8"/>

                <!-- Main ring -->
                <circle cx="250" cy="250" r="170" fill="none" stroke="rgba(0, 240, 255, 0.25)" stroke-width="2"/>

                <!-- Data flow lines -->
                <g stroke="rgba(0, 240, 255, 0.3)" stroke-width="1" fill="none">
                    <path d="M250,80 L250,170"/>
                    <path d="M330,250 L420,250"/>
                    <path d="M250,330 L250,420"/>
                    <path d="M80,250 L170,250"/>
                </g>

                <!-- Center glow -->
                <circle cx="250" cy="250" r="120" fill="url(#centerGlow)"/>
                <circle cx="250" cy="250" r="100" fill="none" stroke="rgba(0, 240, 255, 0.12)" stroke-width="1"/>

                <!-- Direction highlight circles (hidden by default) -->
                <circle class="dir-highlight north-highlight" cx="250" cy="80" r="50" fill="rgba(0, 240, 255, 0.15)" filter="url(#strongGlow)"/>
                <circle class="dir-highlight east-highlight" cx="420" cy="250" r="50" fill="rgba(255, 184, 0, 0.15)" filter="url(#strongGlow)"/>
                <circle class="dir-highlight south-highlight" cx="250" cy="420" r="50" fill="rgba(57, 255, 20, 0.15)" filter="url(#strongGlow)"/>
                <circle class="dir-highlight west-highlight" cx="80" cy="250" r="50" fill="rgba(191, 90, 242, 0.15)" filter="url(#strongGlow)"/>

                <!-- Cardinal arrows -->
                <g filter="url(#glow)">
                    <g class="arrow-north">
                        <polygon points="250,80 262,155 250,135 238,155" fill="url(#cyanGrad)" opacity="0.9"/>
                    </g>
                    <g class="arrow-east">
                        <polygon points="420,250 345,238 365,250 345,262" fill="url(#amberGrad)" opacity="0.9"/>
                    </g>
                    <g class="arrow-south">
                        <polygon points="250,420 238,345 250,365 262,345" fill="url(#greenGrad)" opacity="0.9"/>
                    </g>
                    <g class="arrow-west">
                        <polygon points="80,250 155,262 135,250 155,238" fill="url(#purpleGrad)" opacity="0.9"/>
                    </g>
                </g>

                <!-- Diagonal arrows (dimmer) -->
                <g opacity="0.25">
                    <polygon points="250,115 255,145 250,135 245,145" fill="#00f0ff" transform="rotate(45, 250, 250)"/>
                    <polygon points="250,115 255,145 250,135 245,145" fill="#00f0ff" transform="rotate(135, 250, 250)"/>
                    <polygon points="250,115 255,145 250,135 245,145" fill="#00f0ff" transform="rotate(225, 250, 250)"/>
                    <polygon points="250,115 255,145 250,135 245,145" fill="#00f0ff" transform="rotate(315, 250, 250)"/>
                </g>

                <!-- Labels -->
                <g font-family="Orbitron, monospace" font-weight="700" text-anchor="middle">
                    <text x="250" y="55" fill="#00f0ff" font-size="12" letter-spacing="3" filter="url(#softGlow)">HUMAN</text>
                    <text x="250" y="68" fill="#00f0ff" font-size="8" letter-spacing="1" opacity="0.6">↑ W</text>
                    <text x="448" y="247" fill="#ffb800" font-size="12" letter-spacing="3" filter="url(#softGlow)">AGENT</text>
                    <text x="448" y="260" fill="#ffb800" font-size="8" letter-spacing="1" opacity="0.6">→ D</text>
                    <text x="250" y="455" fill="#39FF14" font-size="12" letter-spacing="3" filter="url(#softGlow)">ENERGY</text>
                    <text x="250" y="468" fill="#39FF14" font-size="8" letter-spacing="1" opacity="0.6">↓ S</text>
                    <text x="52" y="247" fill="#bf5af2" font-size="12" letter-spacing="3" filter="url(#softGlow)">VALUE</text>
                    <text x="52" y="260" fill="#bf5af2" font-size="8" letter-spacing="1" opacity="0.6">← A</text>
                </g>

                <!-- Center -->
                <circle cx="250" cy="250" r="25" fill="#0c1018" stroke="#00f0ff" stroke-width="2"/>
                <circle cx="250" cy="250" r="15" fill="#00f0ff" opacity="0.1"/>
                <circle cx="250" cy="250" r="8" fill="#00f0ff" opacity="0.4" filter="url(#glow)"/>

                <!-- Corner brackets -->
                <g stroke="#00f0ff" stroke-width="1" fill="none" opacity="0.25">
                    <path d="M15,15 L15,55 M15,15 L55,15"/>
                    <path d="M485,15 L485,55 M485,15 L445,15"/>
                    <path d="M15,485 L15,445 M15,485 L55,485"/>
                    <path d="M485,485 L485,445 M485,485 L445,485"/>
                </g>
            </svg>
        </div>

        <!-- Tutorial -->
        <div class="tutorial-prompt">
            <p class="tutorial-text">TRY THE CONTROLS — Press each direction to continue</p>
            <div class="tutorial-keys">
                <div class="key-hint north" id="keyUp">↑</div>
            </div>
            <div class="tutorial-keys">
                <div class="key-hint west" id="keyLeft">←</div>
                <div class="key-hint south" id="keyDown">↓</div>
                <div class="key-hint east" id="keyRight">→</div>
            </div>
            <p class="tutorial-progress"><span id="tutorialCount">0</span> / 4 directions tested</p>
        </div>

        <!-- Info -->
        <div class="briefing-info">
            <h3>PARAMETERS</h3>
            <ul>
                <li>Navigate with ↑↓←→ or WASD</li>
                <li>Locked paths cost Qi to unlock</li>
                <li>Backspace or BACK button to return</li>
                <li>Starting reserve: 500 Qi</li>
            </ul>
        </div>

        <button class="briefing-enter" id="enterBtn" onclick="enterCompass()">
            BEGIN EXPLORATION
        </button>
        <p class="briefing-enter-hint" id="enterHint">Complete the tutorial to unlock</p>
    </div>

    <!-- ==================== MAIN EXPLORATION ==================== -->
    <div class="compass-world" id="compassWorld">
        
        <div class="hud-top">
            <div class="location-display" id="locationDisplay">◇ ORIGIN</div>
            <div class="energy-display">
                <span class="energy-label">QI</span>
                <div class="energy-bar">
                    <div class="energy-fill" id="energyFill" style="width: 100%;"></div>
                </div>
                <span class="energy-value" id="energyValue">500 Qi</span>
            </div>
        </div>

        <div class="main-area">
            <div class="exploration-zone">
                <!-- Mini Compass in corner -->
                <div class="mini-compass">
                    <svg class="mini-compass-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="mcCyan" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00f0ff" />
                                <stop offset="100%" style="stop-color:#0088aa" />
                            </linearGradient>
                            <linearGradient id="mcAmber" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#ffb800" />
                                <stop offset="100%" style="stop-color:#cc8800" />
                            </linearGradient>
                            <linearGradient id="mcGreen" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#39FF14" />
                                <stop offset="100%" style="stop-color:#22aa0a" />
                            </linearGradient>
                            <linearGradient id="mcPurple" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#bf5af2" />
                                <stop offset="100%" style="stop-color:#8a3fbd" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Rings -->
                        <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(0,240,255,0.1)" stroke-width="1"/>
                        <circle cx="50" cy="50" r="35" fill="none" stroke="rgba(0,240,255,0.2)" stroke-width="1"/>
                        
                        <!-- Arrows -->
                        <g class="arrow-group north-arrow" id="mcNorth">
                            <polygon points="50,8 54,28 50,22 46,28" fill="url(#mcCyan)"/>
                        </g>
                        <g class="arrow-group east-arrow" id="mcEast">
                            <polygon points="92,50 72,46 78,50 72,54" fill="url(#mcAmber)"/>
                        </g>
                        <g class="arrow-group south-arrow" id="mcSouth">
                            <polygon points="50,92 46,72 50,78 54,72" fill="url(#mcGreen)"/>
                        </g>
                        <g class="arrow-group west-arrow" id="mcWest">
                            <polygon points="8,50 28,54 22,50 28,46" fill="url(#mcPurple)"/>
                        </g>
                        
                        <!-- Center -->
                        <circle class="center-dot" id="mcCenter" cx="50" cy="50" r="6" fill="#00f0ff"/>
                        <circle cx="50" cy="50" r="3" fill="#0c1018"/>
                    </svg>
                </div>

                <div class="node-container">
                    <div class="node-content" id="nodeContent"></div>
                </div>
            </div>

            <aside class="pathway-index">
                <div class="index-header">
                    <div class="index-title">PATHWAY INDEX</div>
                    <div class="index-stats" id="indexStats">Explored: 1 / 16</div>
                </div>
                <div class="index-list" id="indexList"></div>
            </aside>
        </div>

        <div class="hud-bottom">
            <div class="nav-controls">
                <button class="nav-btn back-btn" id="backBtn" onclick="goBack()" disabled>← BACK</button>
                <div class="nav-dpad">
                    <button class="nav-btn" id="btnNorth" onclick="navigate('north')">▲</button>
                    <button class="nav-btn" id="btnWest" onclick="navigate('west')">◀</button>
                    <button class="nav-btn" id="btnSouth" onclick="navigate('south')">▼</button>
                    <button class="nav-btn" id="btnEast" onclick="navigate('east')">▶</button>
                </div>
            </div>

            <div class="path-display">PATH: <span id="pathDisplay">origin</span></div>

            <a href="index.html" class="back-link">← QI.XYZ</a>
        </div>
    </div>

    <script>
        // ============================================
        // TUTORIAL STATE
        // ============================================
        let tutorialComplete = false;
        const testedDirections = { north: false, east: false, south: false, west: false };
        
        const keyUp = document.getElementById('keyUp');
        const keyDown = document.getElementById('keyDown');
        const keyLeft = document.getElementById('keyLeft');
        const keyRight = document.getElementById('keyRight');
        const tutorialCount = document.getElementById('tutorialCount');
        const enterBtn = document.getElementById('enterBtn');
        const enterHint = document.getElementById('enterHint');
        
        // Hero compass elements
        const heroCompass = document.getElementById('heroCompass');
        const northHighlight = heroCompass.querySelector('.north-highlight');
        const eastHighlight = heroCompass.querySelector('.east-highlight');
        const southHighlight = heroCompass.querySelector('.south-highlight');
        const westHighlight = heroCompass.querySelector('.west-highlight');
        const arrowNorth = heroCompass.querySelector('.arrow-north');
        const arrowEast = heroCompass.querySelector('.arrow-east');
        const arrowSouth = heroCompass.querySelector('.arrow-south');
        const arrowWest = heroCompass.querySelector('.arrow-west');

        function highlightDirection(dir) {
            // Clear all
            [northHighlight, eastHighlight, southHighlight, westHighlight].forEach(h => h.classList.remove('active'));
            [arrowNorth, arrowEast, arrowSouth, arrowWest].forEach(a => a.classList.remove('pulse'));
            [keyUp, keyDown, keyLeft, keyRight].forEach(k => k.classList.remove('active'));

            // Highlight specific
            if (dir === 'north') {
                northHighlight.classList.add('active');
                arrowNorth.classList.add('pulse');
                keyUp.classList.add('active');
                if (!testedDirections.north) { testedDirections.north = true; updateTutorial(); }
            } else if (dir === 'east') {
                eastHighlight.classList.add('active');
                arrowEast.classList.add('pulse');
                keyRight.classList.add('active');
                if (!testedDirections.east) { testedDirections.east = true; updateTutorial(); }
            } else if (dir === 'south') {
                southHighlight.classList.add('active');
                arrowSouth.classList.add('pulse');
                keyDown.classList.add('active');
                if (!testedDirections.south) { testedDirections.south = true; updateTutorial(); }
            } else if (dir === 'west') {
                westHighlight.classList.add('active');
                arrowWest.classList.add('pulse');
                keyLeft.classList.add('active');
                if (!testedDirections.west) { testedDirections.west = true; updateTutorial(); }
            }

            // Clear after delay
            setTimeout(() => {
                [northHighlight, eastHighlight, southHighlight, westHighlight].forEach(h => h.classList.remove('active'));
                [arrowNorth, arrowEast, arrowSouth, arrowWest].forEach(a => a.classList.remove('pulse'));
            }, 300);
        }

        function updateTutorial() {
            const count = Object.values(testedDirections).filter(v => v).length;
            tutorialCount.textContent = count;
            
            // Mark tested keys
            if (testedDirections.north) keyUp.classList.add('active');
            if (testedDirections.east) keyRight.classList.add('active');
            if (testedDirections.south) keyDown.classList.add('active');
            if (testedDirections.west) keyLeft.classList.add('active');

            if (count >= 4) {
                tutorialComplete = true;
                enterBtn.classList.add('ready');
                enterHint.textContent = 'Press ENTER or click to begin';
            }
        }

        // ============================================
        // NODES
        // ============================================
        const nodes = {
            origin: {
                title: "ORIGIN", subtitle: "The compass center",
                color: "var(--qi-cyan)", glow: "var(--qi-cyan-glow)",
                description: "You stand at the nexus. Four cardinal directions extend before you, each representing a fundamental axis of the human-agent-energy relationship.",
                data: [{ label: "POSITION", value: "Center" }, { label: "DEPTH", value: "0" }, { label: "PATHS", value: "4" }],
                tags: ["Start", "Nexus"],
                north: "human", east: "agent", south: "energy", west: "value",
                category: "core"
            },
            human: {
                title: "HUMAN", subtitle: "The mandate issuer",
                color: "var(--qi-cyan)", glow: "var(--qi-cyan-glow)",
                description: "Humans define intent through mandates — bounded instructions that constrain agent behavior.",
                data: [{ label: "ROLE", value: "Principal" }, { label: "FUNCTION", value: "Intent" }, { label: "PROTOCOL", value: "AP2" }],
                tags: ["Mandates", "Intent"],
                north: "locked:intent_theory", east: "human_agent", south: "origin", west: "human_value",
                category: "cardinal"
            },
            agent: {
                title: "AGENT", subtitle: "The autonomous executor",
                color: "var(--qi-amber)", glow: "rgba(255, 184, 0, 0.4)",
                description: "Agents are autonomous programs with on-chain identity (ERC-8004). They receive mandates and return value.",
                data: [{ label: "ROLE", value: "Executor" }, { label: "IDENTITY", value: "ERC-8004" }, { label: "PROTOCOL", value: "A2A" }],
                tags: ["Autonomous", "Identity"],
                north: "agent_human", east: "locked:agent_registry", south: "agent_energy", west: "origin",
                category: "cardinal"
            },
            energy: {
                title: "ENERGY", subtitle: "The fuel of computation",
                color: "var(--qi-green)", glow: "rgba(57, 255, 20, 0.4)",
                description: "Qi tokens represent computational capacity — the ability to run inference, execute transactions, store data.",
                data: [{ label: "ROLE", value: "Fuel" }, { label: "TOKEN", value: "Qi" }, { label: "PROTOCOL", value: "x402" }],
                tags: ["Qi", "x402"],
                north: "origin", east: "energy_agent", south: "locked:thermodynamics", west: "energy_value",
                category: "cardinal"
            },
            value: {
                title: "VALUE", subtitle: "The return path",
                color: "var(--qi-purple)", glow: "rgba(191, 90, 242, 0.4)",
                description: "Value flows back to humans — completed tasks, data, content. Quality determines reputation.",
                data: [{ label: "ROLE", value: "Return" }, { label: "MEASURE", value: "Reputation" }, { label: "PROTOCOL", value: "Settlement" }],
                tags: ["Outcomes", "Trust"],
                north: "value_human", east: "origin", south: "value_energy", west: "locked:value_theory",
                category: "cardinal"
            },
            human_agent: {
                title: "HUMAN → AGENT", subtitle: "Delegation interface",
                color: "var(--qi-cyan)", glow: "var(--qi-cyan-glow)",
                description: "Where human intent becomes agent action. Mandates signed, boundaries set.",
                data: [{ label: "INTERFACE", value: "Mandate" }, { label: "FLOW", value: "Outbound" }],
                tags: ["Delegation"],
                north: null, east: "agent_human", south: "origin", west: "human",
                category: "intersection"
            },
            agent_human: {
                title: "AGENT → HUMAN", subtitle: "Reporting interface",
                color: "var(--qi-amber)", glow: "rgba(255, 184, 0, 0.4)",
                description: "Agents report status and completions. This channel carries accountability.",
                data: [{ label: "INTERFACE", value: "Report" }, { label: "FLOW", value: "Inbound" }],
                tags: ["Accountability"],
                north: "human", east: null, south: "agent", west: "human_agent",
                category: "intersection"
            },
            human_value: {
                title: "HUMAN ← VALUE", subtitle: "Satisfaction endpoint",
                color: "var(--qi-purple)", glow: "rgba(191, 90, 242, 0.4)",
                description: "Where value returns to humans. Completion of mandates.",
                data: [{ label: "INTERFACE", value: "Delivery" }, { label: "FLOW", value: "Inbound" }],
                tags: ["Satisfaction"],
                north: null, east: "human", south: "value_human", west: null,
                category: "intersection"
            },
            value_human: {
                title: "VALUE → HUMAN", subtitle: "Return channel",
                color: "var(--qi-purple)", glow: "rgba(191, 90, 242, 0.4)",
                description: "The path by which completed work flows back.",
                data: [{ label: "INTERFACE", value: "Return" }, { label: "FLOW", value: "Outbound" }],
                tags: ["Delivery"],
                north: "human_value", east: null, south: "value", west: null,
                category: "intersection"
            },
            agent_energy: {
                title: "AGENT → ENERGY", subtitle: "Spending interface",
                color: "var(--qi-amber)", glow: "rgba(255, 184, 0, 0.4)",
                description: "Agents spend energy for compute, data, services via x402.",
                data: [{ label: "INTERFACE", value: "Spend" }, { label: "FLOW", value: "Outbound" }],
                tags: ["x402"],
                north: "agent", east: null, south: "energy_agent", west: "origin",
                category: "intersection"
            },
            energy_agent: {
                title: "ENERGY → AGENT", subtitle: "Fueling interface",
                color: "var(--qi-green)", glow: "rgba(57, 255, 20, 0.4)",
                description: "Energy flows into agents through mandate budgets.",
                data: [{ label: "INTERFACE", value: "Fuel" }, { label: "FLOW", value: "Inbound" }],
                tags: ["Budget"],
                north: "agent_energy", east: null, south: "energy", west: null,
                category: "intersection"
            },
            energy_value: {
                title: "ENERGY → VALUE", subtitle: "Transformation",
                color: "var(--qi-green)", glow: "rgba(57, 255, 20, 0.4)",
                description: "Energy transforms into value through computation.",
                data: [{ label: "INTERFACE", value: "Transform" }, { label: "FLOW", value: "Outbound" }],
                tags: ["Conversion"],
                north: null, east: "energy", south: null, west: "value_energy",
                category: "intersection"
            },
            value_energy: {
                title: "VALUE ← ENERGY", subtitle: "Accounting",
                color: "var(--qi-purple)", glow: "rgba(191, 90, 242, 0.4)",
                description: "Tracking energy cost of produced value.",
                data: [{ label: "INTERFACE", value: "Account" }, { label: "FLOW", value: "Inbound" }],
                tags: ["Efficiency"],
                north: "value", east: "energy_value", south: null, west: null,
                category: "intersection"
            },
            "locked:intent_theory": { locked: true, cost: 50, title: "INTENT THEORY", subtitle: "Locked", preview: "Philosophy of machine intent.", unlocks: "intent_theory", category: "deep" },
            "locked:agent_registry": { locked: true, cost: 75, title: "AGENT REGISTRY", subtitle: "Locked", preview: "Global ERC-8004 registry.", unlocks: "agent_registry", category: "deep" },
            "locked:thermodynamics": { locked: true, cost: 100, title: "THERMODYNAMICS", subtitle: "Locked", preview: "Physics of computational economics.", unlocks: "thermodynamics", category: "deep" },
            "locked:value_theory": { locked: true, cost: 60, title: "VALUE THEORY", subtitle: "Locked", preview: "Economics of utility.", unlocks: "value_theory", category: "deep" },
            intent_theory: {
                title: "INTENT THEORY", subtitle: "Philosophy",
                color: "var(--qi-cyan)", glow: "var(--qi-cyan-glow)",
                description: "Intent bridges human desire and machine action.",
                data: [{ label: "DOMAIN", value: "Philosophy" }],
                tags: ["Formalization"],
                north: null, east: null, south: "human", west: null, category: "deep"
            },
            agent_registry: {
                title: "AGENT REGISTRY", subtitle: "Identity layer",
                color: "var(--qi-amber)", glow: "rgba(255, 184, 0, 0.4)",
                description: "Every agent has an ERC-8004 identity.",
                data: [{ label: "STANDARD", value: "ERC-8004" }],
                tags: ["Registry"],
                north: null, east: null, south: null, west: "agent", category: "deep"
            },
            thermodynamics: {
                title: "THERMODYNAMICS", subtitle: "Physics",
                color: "var(--qi-green)", glow: "rgba(57, 255, 20, 0.4)",
                description: "Computation requires energy. Information has entropy.",
                data: [{ label: "DOMAIN", value: "Physics" }],
                tags: ["Entropy"],
                north: "energy", east: null, south: null, west: null, category: "deep"
            },
            value_theory: {
                title: "VALUE THEORY", subtitle: "Economics",
                color: "var(--qi-purple)", glow: "rgba(191, 90, 242, 0.4)",
                description: "Value is subjective but measurable.",
                data: [{ label: "DOMAIN", value: "Economics" }],
                tags: ["Utility"],
                north: null, east: "value", south: null, west: null, category: "deep"
            }
        };

        // ============================================
        // STATE
        // ============================================
        let currentNode = 'origin';
        let energy = 500;
        let maxEnergy = 500;
        let exploredNodes = new Set(['origin']);
        let pathHistory = ['origin'];
        let gameStarted = false;

        // DOM
        const briefingOverlay = document.getElementById('briefingOverlay');
        const compassWorld = document.getElementById('compassWorld');
        const nodeContent = document.getElementById('nodeContent');
        const locationDisplay = document.getElementById('locationDisplay');
        const energyFill = document.getElementById('energyFill');
        const energyValue = document.getElementById('energyValue');
        const pathDisplay = document.getElementById('pathDisplay');
        const indexStats = document.getElementById('indexStats');
        const indexList = document.getElementById('indexList');
        const flash = document.getElementById('flash');
        const backBtn = document.getElementById('backBtn');
        const btnNorth = document.getElementById('btnNorth');
        const btnEast = document.getElementById('btnEast');
        const btnSouth = document.getElementById('btnSouth');
        const btnWest = document.getElementById('btnWest');
        
        // Mini compass
        const mcNorth = document.getElementById('mcNorth');
        const mcEast = document.getElementById('mcEast');
        const mcSouth = document.getElementById('mcSouth');
        const mcWest = document.getElementById('mcWest');
        const mcCenter = document.getElementById('mcCenter');

        function enterCompass() {
            if (!tutorialComplete) return;
            gameStarted = true;
            briefingOverlay.classList.add('hidden');
            compassWorld.classList.add('active');
            render();
        }

        function render() {
            const node = nodes[currentNode];
            locationDisplay.textContent = `◇ ${node.title || currentNode.toUpperCase()}`;
            energyFill.style.width = `${(energy / maxEnergy) * 100}%`;
            energyValue.textContent = `${energy} Qi`;

            const displayPath = pathHistory.slice(-4).map(p => nodes[p]?.title || p);
            pathDisplay.innerHTML = displayPath.join(' <span>→</span> ');

            backBtn.disabled = pathHistory.length <= 1;

            if (node.locked) {
                renderLocked(node);
            } else {
                renderNode(node);
            }

            updateNavButtons(node);
            updateMiniCompass(node);
            renderIndex();
        }

        function renderNode(node) {
            nodeContent.style.setProperty('--node-color', node.color || 'var(--qi-cyan)');
            nodeContent.style.setProperty('--node-glow', node.glow || 'var(--qi-cyan-glow)');
            
            let dataHTML = node.data ? `<div class="node-data">${node.data.map(d => `
                <div class="data-block"><div class="data-label">${d.label}</div><div class="data-value">${d.value}</div></div>
            `).join('')}</div>` : '';

            let tagsHTML = node.tags ? `<div class="node-tags">${node.tags.map(t => `<span class="node-tag">${t}</span>`).join('')}</div>` : '';

            nodeContent.innerHTML = `
                <div class="node-title">${node.title}</div>
                <div class="node-subtitle">${node.subtitle}</div>
                <div class="node-description">${node.description}</div>
                ${dataHTML}
                ${tagsHTML}
            `;
        }

        function renderLocked(node) {
            nodeContent.style.setProperty('--node-color', 'var(--qi-amber)');
            const canAfford = energy >= node.cost;
            nodeContent.innerHTML = `
                <div class="locked-overlay">
                    <div class="locked-icon">🔒</div>
                    <div class="locked-title">${node.title}</div>
                    <div class="locked-desc">${node.preview}</div>
                    <button class="unlock-btn" onclick="unlockNode()" ${!canAfford ? 'disabled' : ''}>EXPLORE</button>
                    <div class="unlock-cost">Cost: ${node.cost} Qi</div>
                </div>
            `;
        }

        function updateNavButtons(node) {
            btnNorth.disabled = !node.north;
            btnEast.disabled = !node.east;
            btnSouth.disabled = !node.south;
            btnWest.disabled = !node.west;
        }

        function updateMiniCompass(node) {
            // Update arrow availability
            mcNorth.classList.toggle('available', !!node.north);
            mcNorth.classList.toggle('unavailable', !node.north);
            mcEast.classList.toggle('available', !!node.east);
            mcEast.classList.toggle('unavailable', !node.east);
            mcSouth.classList.toggle('available', !!node.south);
            mcSouth.classList.toggle('unavailable', !node.south);
            mcWest.classList.toggle('available', !!node.west);
            mcWest.classList.toggle('unavailable', !node.west);

            // Update center color based on current node
            const colorMap = {
                'var(--qi-cyan)': '#00f0ff',
                'var(--qi-amber)': '#ffb800',
                'var(--qi-green)': '#39FF14',
                'var(--qi-purple)': '#bf5af2'
            };
            mcCenter.style.fill = colorMap[node.color] || '#00f0ff';
        }

        function renderIndex() {
            const totalNodes = Object.keys(nodes).filter(k => !k.startsWith('locked:')).length;
            indexStats.textContent = `Explored: ${exploredNodes.size} / ${totalNodes}`;

            const categories = { core: { title: 'CORE', nodes: [] }, cardinal: { title: 'CARDINAL', nodes: [] }, intersection: { title: 'INTERSECTIONS', nodes: [] }, deep: { title: 'DEEP', nodes: [] } };

            Object.keys(nodes).forEach(key => {
                const node = nodes[key];
                if (key.startsWith('locked:')) return;
                const cat = node.category || 'core';
                if (categories[cat]) categories[cat].nodes.push({ key, node });
            });

            let html = '';
            Object.values(categories).forEach(cat => {
                if (cat.nodes.length === 0) return;
                html += `<div class="index-category"><div class="index-category-title">${cat.title}</div>`;
                cat.nodes.forEach(({ key, node }) => {
                    const isCurrent = key === currentNode;
                    const isExplored = exploredNodes.has(key);
                    let statusClass = isExplored ? '' : 'unexplored';
                    let iconClass = isExplored ? 'explored' : 'unexplored';
                    if (isCurrent) { statusClass = 'current'; iconClass = 'current'; }
                    html += `<div class="index-node ${statusClass}" onclick="jumpToNode('${key}')">
                        <div class="index-node-icon ${iconClass}"></div>
                        <div class="index-node-name">${node.title}</div>
                    </div>`;
                });
                html += `</div>`;
            });
            indexList.innerHTML = html;
        }

        function navigate(direction) {
            if (!gameStarted) return;
            const node = nodes[currentNode];
            let target = node[direction];
            if (!target) return;

            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 100);

            nodeContent.classList.add('transitioning');
            setTimeout(() => {
                pathHistory.push(target);
                currentNode = target;
                exploredNodes.add(target);
                render();
                nodeContent.classList.remove('transitioning');
            }, 200);
        }

        function goBack() {
            if (pathHistory.length <= 1) return;
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 100);
            nodeContent.classList.add('transitioning');
            setTimeout(() => {
                pathHistory.pop();
                currentNode = pathHistory[pathHistory.length - 1];
                render();
                nodeContent.classList.remove('transitioning');
            }, 200);
        }

        function jumpToNode(key) {
            if (!exploredNodes.has(key) || nodes[key].locked) return;
            if (key === currentNode) return;
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 100);
            nodeContent.classList.add('transitioning');
            setTimeout(() => {
                pathHistory.push(key);
                currentNode = key;
                render();
                nodeContent.classList.remove('transitioning');
            }, 200);
        }

        function unlockNode() {
            const node = nodes[currentNode];
            if (!node.locked || energy < node.cost) return;
            energy -= node.cost;
            const unlockedKey = node.unlocks;
            Object.keys(nodes).forEach(key => {
                const n = nodes[key];
                ['north', 'east', 'south', 'west'].forEach(dir => {
                    if (n[dir] === currentNode) n[dir] = unlockedKey;
                });
            });
            pathHistory[pathHistory.length - 1] = unlockedKey;
            currentNode = unlockedKey;
            exploredNodes.add(currentNode);
            render();
        }

        // ============================================
        // KEYBOARD
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Tutorial mode
            if (!gameStarted) {
                if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') { e.preventDefault(); highlightDirection('north'); }
                if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') { e.preventDefault(); highlightDirection('east'); }
                if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') { e.preventDefault(); highlightDirection('south'); }
                if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') { e.preventDefault(); highlightDirection('west'); }
                if ((e.key === 'Enter' || e.key === ' ') && tutorialComplete) { e.preventDefault(); enterCompass(); }
                return;
            }

            // Exploration mode
            switch(e.key) {
                case 'ArrowUp': case 'w': case 'W': e.preventDefault(); navigate('north'); break;
                case 'ArrowRight': case 'd': case 'D': e.preventDefault(); navigate('east'); break;
                case 'ArrowDown': case 's': case 'S': e.preventDefault(); navigate('south'); break;
                case 'ArrowLeft': case 'a': case 'A': e.preventDefault(); navigate('west'); break;
                case 'Backspace': e.preventDefault(); goBack(); break;
                case ' ': case 'Enter':
                    e.preventDefault();
                    if (nodes[currentNode]?.locked) unlockNode();
                    break;
            }
        });
    </script>

</body>
</html>
